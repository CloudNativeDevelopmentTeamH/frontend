stages:
  - üîñ app-version
  - üèóÔ∏è build
  - üöÄ deploy

.node_default:
  image: node:20-alpine
  cache:
    key:
      files:
        - package.json
        - package-lock.json
    paths:
      - node_modules/

.app_version:
  script:
    - APP_VERSION="1.${CI_COMMIT_SHORT_SHA}"
    - echo "APP_VERSION=$APP_VERSION" > app_version.env
    - echo $APP_VERSION > app_version
  artifacts:
    reports:
      dotenv: app_version.env
    paths:
      - app_version
  dependencies: []

.image_names:
  variables:
    IMAGE_NAMESPACE: focusboard
    IMAGE_REPO: frontend
    IMAGE_NAME: ${IMAGE_NAMESPACE}/${IMAGE_REPO}
    HARBOR_IMAGE: $HARBOR_IMAGE_PREFIX/$IMAGE_NAME
    ECR_IMAGE: $ECR_REGISTRY/$IMAGE_NAME

set-app-version:
  stage: üîñ app-version
  extends: .app_version
  image: alpine:latest

build-image:
  stage: üèóÔ∏è build
  extends: .image_names
  needs:
    - set-app-version
  image: docker:latest
  services:
    - docker:dind
  variables:
    DOCKER_TLS_CERTDIR: ""
  before_script:
    - echo "$HARBOR_ROBOT_TOKEN" | docker login "$HARBOR_URL" -u "$HARBOR_ROBOT_NAME" --password-stdin
  script:
    - docker build -t "$HARBOR_IMAGE:$APP_VERSION" -t "$HARBOR_IMAGE:latest" .
    - docker push "$HARBOR_IMAGE:$APP_VERSION"
    - docker push "$HARBOR_IMAGE:latest"

push-image-ecr:
  stage: üèóÔ∏è build
  extends: .image_names
  needs:
    - set-app-version
    - build-image
  image: alpine:latest
  variables:
    AWS_REGION: eu-central-1
  before_script:
    - apk add --no-cache skopeo aws-cli
    - aws ecr describe-repositories --repository-names "$IMAGE_NAME" --region "$AWS_REGION" || aws ecr create-repository --repository-name "$IMAGE_NAME" --region "$AWS_REGION"
    - ECR_PASSWORD="$(aws ecr get-login-password --region "$AWS_REGION")"
  script:
    - skopeo copy --src-creds "$HARBOR_ROBOT_NAME:$HARBOR_ROBOT_TOKEN" --dest-creds "AWS:$ECR_PASSWORD" "docker://$HARBOR_IMAGE:$APP_VERSION" "docker://$ECR_IMAGE:$APP_VERSION"
    - skopeo copy --src-creds "$HARBOR_ROBOT_NAME:$HARBOR_ROBOT_TOKEN" --dest-creds "AWS:$ECR_PASSWORD" "docker://$HARBOR_IMAGE:latest" "docker://$ECR_IMAGE:latest"

deploy-eks-prod:
  stage: üöÄ deploy
  extends: .image_names
  needs:
    - push-image-ecr
  image:
    name: alpine/helm:4.0.5
    entrypoint: [""]
  before_script:
    - apk add aws-cli
    - aws eks update-kubeconfig --region eu-central-1 --name cnd-prod-eks
  script:
    - helm upgrade frontend ./helm -n frontend